<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BONHEUR ART Studio - Transformation Photo en Dessin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #3a6ea5;
            --secondary-color: #004e92;
            --accent-color: #ff9a56;
            --light-bg: #f9f9f9;
            --dark-text: #333;
            --light-text: #fff;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark-text);
            line-height: 1.6;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .logo {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .logo i {
            margin-right: 10px;
            color: var(--accent-color);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .subtitle {
            font-size: 16px;
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .control-panel {
            background: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .panel-title {
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            color: var(--primary-color);
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background: var(--primary-color);
            color: var(--light-text);
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-accent {
            background: var(--accent-color);
        }
        
        .btn-accent:hover {
            background: #ff7e2e;
        }
        
        .file-upload {
            position: relative;
            overflow: hidden;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            font-size: 100px;
            opacity: 0;
            right: 0;
            top: 0;
            cursor: pointer;
        }
        
        .slider-container {
            margin-bottom: 25px;
        }
        
        .slider-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .slider-label {
            flex: 1;
            font-weight: 600;
        }
        
        .slider {
            flex: 2;
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }
        
        .slider-value {
            width: 35px;
            text-align: center;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .preview-area {
            text-align: center;
        }
        
        .canvas-container {
            position: relative;
            margin-bottom: 20px;
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: var(--border-radius);
            visibility: hidden;
            opacity: 0;
            transition: var(--transition);
        }
        
        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .style-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .style-option {
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            padding: 10px;
            text-align: center;
            transition: var(--transition);
        }
        
        .style-option:hover, .style-option.active {
            border-color: var(--accent-color);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .style-option img {
            width: 100%;
            height: auto;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        
        .style-option span {
            font-size: 14px;
            font-weight: 600;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
            margin-bottom: 0;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            color: #777;
            font-size: 14px;
        }
        
        .video-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .video-inner {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        
        .video-inner video {
            max-width: 100%;
            max-height: 80vh;
            display: block;
        }
        
        .close-video {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 101;
        }
        
        .camera-flash {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            opacity: 0;
            z-index: 102;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .flash-animation {
            animation: flash 0.5s;
        }
        
        .before-after-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .before-after-item {
            flex: 1;
            background: white;
            padding: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .before-after-title {
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .history-container {
            margin-top: 30px;
        }
        
        .history-title {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .history-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .history-item {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .history-item:hover {
            transform: scale(1.05);
            box-shadow: var(--box-shadow);
        }
        
        .history-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .tooltips {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            pointer-events: none;
            transition: var(--transition);
            opacity: 0;
        }
        
        .tooltips.show {
            opacity: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 600;
        }
        
        .tab:hover {
            color: var(--primary-color);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .before-after-container {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-palette"></i>
                <span>BONHEUR ART</span>
            </div>
            <h1>Transformez vos Photos en Œuvres d'Art</h1>
            <p class="subtitle">Notre studio numérique professionnel utilise des algorithmes avancés pour transformer vos photos en magnifiques dessins et illustrations artistiques avec un réalisme exceptionnel.</p>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <h2 class="panel-title">Commandes</h2>
                
                <div class="control-group">
                    <label class="control-label">Image Source</label>
                    <button id="uploadBtn" class="btn file-upload">
                        <i class="fas fa-upload"></i> Télécharger une Photo
                        <input type="file" id="upload" accept="image/*">
                    </button>
                    <button id="takePhotoBtn" class="btn">
                        <i class="fas fa-camera"></i> Prendre un Selfie
                    </button>
                </div>
                
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="basic">Basique</div>
                        <div class="tab" data-tab="advanced">Avancé</div>
                    </div>
                    
                    <div id="basicTab" class="tab-content active">
                        <div class="control-group">
                            <label class="control-label">Style de Dessin</label>
                            <div class="style-selector">
                                <div class="style-option active" data-style="sketch">
                                    <img src="/api/placeholder/80/80" alt="Croquis">
                                    <span>Croquis</span>
                                </div>
                                <div class="style-option" data-style="pencil">
                                    <img src="/api/placeholder/80/80" alt="Crayon">
                                    <span>Crayon</span>
                                </div>
                                <div class="style-option" data-style="charcoal">
                                    <img src="/api/placeholder/80/80" alt="Fusain">
                                    <span>Fusain</span>
                                </div>
                                <div class="style-option" data-style="cartoon">
                                    <img src="/api/placeholder/80/80" alt="Cartoon">
                                    <span>Cartoon</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-group">
                                <span class="slider-label">Intensité</span>
                                <input type="range" min="1" max="20" value="10" class="slider" id="intensitySlider">
                                <span class="slider-value" id="intensityValue">10</span>
                            </div>
                            
                            <div class="slider-group">
                                <span class="slider-label">Contraste</span>
                                <input type="range" min="1" max="20" value="10" class="slider" id="contrastSlider">
                                <span class="slider-value" id="contrastValue">10</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="advancedTab" class="tab-content">
                        <div class="slider-container">
                            <div class="slider-group">
                                <span class="slider-label">Détail</span>
                                <input type="range" min="1" max="20" value="10" class="slider" id="detailSlider">
                                <span class="slider-value" id="detailValue">10</span>
                            </div>
                            
                            <div class="slider-group">
                                <span class="slider-label">Épaisseur</span>
                                <input type="range" min="1" max="10" value="3" class="slider" id="thicknessSlider">
                                <span class="slider-value" id="thicknessValue">3</span>
                            </div>
                            
                            <div class="slider-group">
                                <span class="slider-label">Luminosité</span>
                                <input type="range" min="1" max="20" value="10" class="slider" id="brightnessSlider">
                                <span class="slider-value" id="brightnessValue">10</span>
                            </div>
                            
                            <div class="slider-group">
                                <span class="slider-label">Texture</span>
                                <input type="range" min="0" max="10" value="3" class="slider" id="textureSlider">
                                <span class="slider-value" id="textureValue">3</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="applyBtn" class="btn btn-accent">
                        <i class="fas fa-magic"></i> Appliquer
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <i class="fas fa-undo"></i> Réinitialiser
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button id="downloadBtn" class="btn">
                        <i class="fas fa-download"></i> Télécharger
                    </button>
                    <button id="shareBtn" class="btn">
                        <i class="fas fa-share-alt"></i> Partager
                    </button>
                </div>
            </div>
            
            <div class="preview-area">
                <div class="canvas-container">
                    <canvas id="canvas">Votre navigateur ne supporte pas Canvas HTML5</canvas>
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div class="before-after-container">
                    <div class="before-after-item">
                        <div class="before-after-title">Original</div>
                        <canvas id="originalCanvas"></canvas>
                    </div>
                    <div class="before-after-item">
                        <div class="before-after-title">Transformation</div>
                        <canvas id="resultCanvas"></canvas>
                    </div>
                </div>
                
                <div class="history-container">
                    <h3 class="history-title">Historique des modifications</h3>
                    <div class="history-items" id="historyContainer">
                        <!-- History items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2025 BONHEUR ART Studio. Tous droits réservés.</p>
        </div>
    </div>
    
    <div class="video-container" id="videoContainer">
        <div class="video-inner">
            <span class="close-video" id="closeVideo"><i class="fas fa-times"></i></span>
            <video id="video"></video>
            <div class="countdown" id="countdown"></div>
            <div class="camera-flash" id="cameraFlash"></div>
        </div>
    </div>
    
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <h3 class="modal-title">Partager votre création</h3>
            <div class="modal-body">
                <p>Partagez votre magnifique création avec vos amis et votre famille.</p>
                <div class="share-options" style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                    <button class="btn" style="width: auto; padding: 10px 15px;">
                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="btn" style="width: auto; padding: 10px 15px;">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="btn" style="width: auto; padding: 10px 15px;">
                        <i class="fab fa-instagram"></i>
                    </button>
                    <button class="btn" style="width: auto; padding: 10px 15px;">
                        <i class="fab fa-pinterest-p"></i>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeShareModal" class="btn btn-secondary">Fermer</button>
            </div>
        </div>
    </div>
    
    <div id="tooltip" class="tooltips"></div>

    <script>
        // DOM Elements
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const originalCanvas = document.getElementById('originalCanvas');
        const originalCtx = originalCanvas.getContext('2d');
        const resultCanvas = document.getElementById('resultCanvas');
        const resultCtx = resultCanvas.getContext('2d');
        const upload = document.getElementById('upload');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const videoContainer = document.getElementById('videoContainer');
        const video = document.getElementById('video');
        const closeVideo = document.getElementById('closeVideo');
        const countdown = document.getElementById('countdown');
        const cameraFlash = document.getElementById('cameraFlash');
        const applyBtn = document.getElementById('applyBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const shareBtn = document.getElementById('shareBtn');
        const shareModal = document.getElementById('shareModal');
        const closeShareModal = document.getElementById('closeShareModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const historyContainer = document.getElementById('historyContainer');
        const tooltip = document.getElementById('tooltip');
        
        // Sliders
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const contrastSlider = document.getElementById('contrastSlider');
        const contrastValue = document.getElementById('contrastValue');
        const detailSlider = document.getElementById('detailSlider');
        const detailValue = document.getElementById('detailValue');
        const thicknessSlider = document.getElementById('thicknessSlider');
        const thicknessValue = document.getElementById('thicknessValue');
        const brightnessSlider = document.getElementById('brightnessSlider');
        const brightnessValue = document.getElementById('brightnessValue');
        const textureSlider = document.getElementById('textureSlider');
        const textureValue = document.getElementById('textureValue');
        
        // Tabs
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Style Options
        const styleOptions = document.querySelectorAll('.style-option');
        
        // Application State
        const state = {
            originalImage: null,
            currentEffect: 'sketch',
            history: [],
            historyIndex: -1,
            settings: {
                intensity: 10,
                contrast: 10,
                detail: 10,
                thickness: 3,
                brightness: 10,
                texture: 3
            }
        };
        
        // Initialize empty canvas
        function initializeCanvas() {
            // Set default canvas size
            canvas.width = 600;
            canvas.height = 400;
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#999';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Téléchargez une image ou prenez une photo pour commencer', canvas.width/2, canvas.height/2);
            
            // Set up original and result canvases
            originalCanvas.width = 280;
            originalCanvas.height = 200;
            originalCtx.fillStyle = '#f5f5f5';
            originalCtx.fillRect(0, 0, originalCanvas.width, originalCanvas.height);
            
            resultCanvas.width = 280;
            resultCanvas.height = 200;
            resultCtx.fillStyle = '#f5f5f5';
            resultCtx.fillRect(0, 0, resultCanvas.width, resultCanvas.height);
        }
        
        // Load image from file or camera
        function loadImage(src, isFile = true) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                
                if (isFile) {
                    img.src = URL.createObjectURL(src);
                } else {
                    img.src = src;
                }
                
                img.onload = () => {
                    // Store original image
                    state.originalImage = img;
                    
                    // Calculate aspect ratio
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let width = img.width;
                    let height = img.height;
                    
                    // Resize if needed
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    // Set canvas dimensions
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw original image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Set original canvas
                    const aspectRatio = width / height;
                    originalCanvas.width = 280;
                    originalCanvas.height = 280 / aspectRatio;
                    originalCtx.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);
                    
                    // Set result canvas with same dimensions
                    resultCanvas.width = 280;
                    resultCanvas.height = 280 / aspectRatio;
                    
                    // Save to history
                    saveToHistory();
                    
                    resolve();
                };
                
                img.onerror = reject;
            });
        }
        
        // Apply sketch effect based on current settings
        function applyEffect() {
            if (!state.originalImage) return;
            
            showLoading(true);
            
            setTimeout(() => {
                const intensity = parseInt(intensitySlider.value);
                const contrast = parseInt(contrastSlider.value);
                const detail = parseInt(detailSlider.value);
                const thickness = parseInt(thicknessSlider.value);
                const brightness = parseInt(brightnessSlider.value);
                const texture = parseInt(textureSlider.value);
                
                // Save settings
                state.settings = {
                    intensity,
                    contrast,
                    detail,
                    thickness,
                    brightness,
                    texture
                };
                
                // Apply effect based on style
                switch(state.currentEffect) {
                    case 'sketch':
                        applySketchEffect();
                        break;
                    case 'pencil':
                        applyPencilEffect();
                        break;
                    case 'charcoal':
                        applyCharcoalEffect();
                        break;
                    case 'cartoon':
                        applyCartoonEffect();
                        break;
                    default:
                        applySketchEffect();
                }
                
                // Save to history
                saveToHistory();
                
                showLoading(false);
            }, 500);
        }
        
        // Apply sketch effect
        function applySketchEffect() {
            if (!state.originalImage) return;
            
            // Reset canvas with original image
            ctx.drawImage(state.originalImage, 0, 0, canvas.width, canvas.height);
            
            // Get image data
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            
            // Apply grayscale with contrast
            let contrast = 1 + (state.settings.contrast * 0.05);
            let brightness = (state.settings.brightness - 10) * 3;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                
                // Convert to grayscale
                let gray = 0.3 * r + 0.59 * g + 0.11 * b;
                
                // Apply contrast
                gray = Math.min(255, Math.max(0, contrast * (gray - 128) + 128 + brightness));
                
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Detect edges
            detectEdges(state.settings.intensity, state.settings.detail, state.settings.thickness);
            
            // Apply texture if enabled
            if (state.settings.texture > 0) {
                applyTexture(state.settings.texture);
            }
            
            // Update result canvas
            resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.drawImage(canvas, 0, 0, resultCanvas.width, resultCanvas.height);
        }
        
        // Apply pencil effect
        function applyPencilEffect() {
            if (!state.originalImage) return;
            
            // Reset canvas with original image
            ctx.drawImage(state.originalImage, 0, 0, canvas.width, canvas.height);
            
            // Get image data
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            
            // Apply grayscale with high contrast
            let contrast = 1 + (state.settings.contrast * 0.08);
            let brightness = (state.settings.brightness - 10) * 3;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                
                // Convert to grayscale
                let gray = 0.3 * r + 0.59 * g + 0.11 * b;
                
                // Apply contrast
                gray = Math.min(255, Math.max(0, contrast * (gray - 128) + 128 + brightness));
                
                // Create pencil-like effect by adding noise
                let noise = Math.random() * 10 - 5;
                gray = Math.min(255, Math.max(0, gray + noise));
                
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Detect edges with thinner lines
            detectEdges(state.settings.intensity * 0.8, state.settings.detail * 1.2, state.settings.thickness * 0.7);
            
            // Apply paper texture
            applyTexture(state.settings.texture);
            
            // Add hatching effect for shading
            if (state.settings.detail > 5) {
                applyHatching();
            }
            
            // Update result canvas
            resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.drawImage(canvas, 0, 0, resultCanvas.width, resultCanvas.height);
        }
        
        // Apply charcoal effect
        function applyCharcoalEffect() {
            if (!state.originalImage) return;
            
            // Reset canvas with original image
            ctx.drawImage(state.originalImage, 0, 0, canvas.width, canvas.height);
            
            // Get image data
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            
            // Apply high contrast grayscale
            let contrast = 1 + (state.settings.contrast * 0.1);
            let brightness = (state.settings.brightness - 10) * 4;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                
                // Convert to grayscale
                let gray = 0.3 * r + 0.59 * g + 0.11 * b;
                
                // Apply contrast
                gray = Math.min(255, Math.max(0, contrast * (gray - 128) + 128 + brightness));
                
                // Add grain
                let grain = Math.random() * 20 - 10;
                gray = Math.min(255, Math.max(0, gray + grain));
                
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Detect edges with thicker lines
            detectEdges(state.settings.intensity * 1.2, state.settings.detail * 0.8, state.settings.thickness * 1.5);
            
            // Apply smudge effect
            applySmudge();
            
            // Apply texture
            applyTexture(state.settings.texture * 1.5);
            
            // Update result canvas
            resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.drawImage(canvas, 0, 0, resultCanvas.width, resultCanvas.height);
        }
        
        // Apply cartoon effect
        function applyCartoonEffect() {
            if (!state.originalImage) return;
            
            // Reset canvas with original image
            ctx.drawImage(state.originalImage, 0, 0, canvas.width, canvas.height);
            
            // Get image data
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            
            // Apply color quantization
            let levels = Math.max(2, Math.floor(state.settings.detail * 0.5));
            let levelSize = 256 / levels;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                
                // Quantize colors
                data[i] = Math.floor(r / levelSize) * levelSize;
                data[i + 1] = Math.floor(g / levelSize) * levelSize;
                data[i + 2] = Math.floor(b / levelSize) * levelSize;
                
                // Adjust brightness
                let brightness = (state.settings.brightness - 10) * 5;
                data[i] = Math.min(255, Math.max(0, data[i] + brightness));
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + brightness));
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + brightness));
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // Store color version temporarily
            let tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            let tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            // Detect edges with thick lines
            detectEdges(state.settings.intensity * 1.5, state.settings.detail, state.settings.thickness * 2);
            
            // Keep only the edges
            let edgeData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let edgePixels = edgeData.data;
            
            // Draw color image back
            ctx.drawImage(tempCanvas, 0, 0);
            
            // Overlay edges
            let finalData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let finalPixels = finalData.data;
            
            for (let i = 0; i < finalPixels.length; i += 4) {
                // If this is an edge pixel (dark), keep it
                if (edgePixels[i] < 50) {
                    finalPixels[i] = finalPixels[i + 1] = finalPixels[i + 2] = 0;
                }
            }
            
            ctx.putImageData(finalData, 0, 0);
            
            // Update result canvas
            resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.drawImage(canvas, 0, 0, resultCanvas.width, resultCanvas.height);
        }
        
        // Edge detection function
        function detectEdges(intensity, detail, thickness) {
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            let width = imageData.width;
            let height = imageData.height;
            let edgeData = new Uint8ClampedArray(data.length);
            
            // Calculate threshold based on intensity
            let threshold = 10 + (20 - intensity) * 4;
            let detailFactor = Math.max(1, detail);
            
            // Sobel operators
            const sobelX = [
                [-1, 0, 1],
                [-2, 0, 2],
                [-1, 0, 1]
            ];
            
            const sobelY = [
                [-1, -2, -1],
                [0, 0, 0],
                [1, 2, 1]
            ];
            
            // Apply Sobel operators
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    let gx = 0;
                    let gy = 0;
                    
                    // Apply convolution
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            let idx = ((y + ky) * width + (x + kx)) * 4;
                            let val = data[idx];
                            gx += val * sobelX[ky + 1][kx + 1];
                            gy += val * sobelY[ky + 1][kx + 1];
                        }
                    }
                    
                    // Calculate edge magnitude
                    let magnitude = Math.sqrt(gx * gx + gy * gy);
                    
                    // Apply threshold
                    let i = (y * width + x) * 4;
                    edgeData[i] = edgeData[i + 1] = edgeData[i + 2] = magnitude > threshold ? 0 : 255;
                    edgeData[i + 3] = 255;
                }
            }
            
            // Apply edge thickness
            if (thickness > 1) {
                let tempData = new Uint8ClampedArray(edgeData);
                let thicknessScale = Math.min(3, thickness);
                let radius = Math.ceil(thicknessScale);
                
                for (let y = radius; y < height - radius; y++) {
                    for (let x = radius; x < width - radius; x++) {
                        let centerIdx = (y * width + x) * 4;
                        
                        // If this is an edge pixel
                        if (tempData[centerIdx] === 0) {
                            // Expand the edge
                            for (let dy = -radius; dy <= radius; dy++) {
                                for (let dx = -radius; dx <= radius; dx++) {
                                    if (dx * dx + dy * dy <= radius * radius) {
                                        let idx = ((y + dy) * width + (x + dx)) * 4;
                                        edgeData[idx] = edgeData[idx + 1] = edgeData[idx + 2] = 0;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Create new ImageData and draw it
            let edgeImage = new ImageData(edgeData, width, height);
            ctx.putImageData(edgeImage, 0, 0);
        }
        
        // Apply texture effect
        function applyTexture(intensity) {
            if (intensity <= 0) return;
            
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            
            // Scale texture intensity
            intensity = intensity * 2;
            
            // Apply paper texture
            for (let i = 0; i < data.length; i += 4) {
                // Create texture noise
                let noise = (Math.random() - 0.5) * intensity;
                
                // Apply noise
                data[i] = Math.min(255, Math.max(0, data[i] + noise));
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + noise));
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + noise));
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // Apply hatching effect for pencil drawings
        function applyHatching() {
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            let width = imageData.width;
            let height = imageData.height;
            
            // Create a temporary canvas for hatching
            let tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            let tempCtx = tempCanvas.getContext('2d');
            
            // Draw original image
            tempCtx.drawImage(canvas, 0, 0);
            
            // Apply hatching based on brightness
            for (let y = 0; y < height; y += 4) {
                for (let x = 0; x < width; x += 1) {
                    let idx = (y * width + x) * 4;
                    let brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                    
                    // Darker areas get more hatching
                    if (brightness < 100) {
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x + 4, y + 4);
                        ctx.strokeStyle = `rgba(0, 0, 0, ${0.1 - brightness/1000})`;
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                    }
                }
            }
            
            // Draw hatching in the opposite direction for darker areas
            for (let y = 0; y < height; y += 5) {
                for (let x = 0; x < width; x += 1) {
                    let idx = (y * width + x) * 4;
                    let brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                    
                    if (brightness < 60) {
                        ctx.beginPath();
                        ctx.moveTo(x + 4, y);
                        ctx.lineTo(x, y + 4);
                        ctx.strokeStyle = `rgba(0, 0, 0, ${0.1 - brightness/1000})`;
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                    }
                }
            }
        }
        
        // Apply smudge effect for charcoal drawings
        function applySmudge() {
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            let width = imageData.width;
            let height = imageData.height;
            let radius = 2;
            
            // Create a temporary copy of the image data
            let tempData = new Uint8ClampedArray(data);
            
            // Apply smudge effect
            for (let y = radius; y < height - radius; y++) {
                for (let x = radius; x < width - radius; x++) {
                    let centerIdx = (y * width + x) * 4;
                    
                    // Skip white pixels
                    if (data[centerIdx] > 200) continue;
                    
                    // Random smudge direction
                    let dx = Math.floor(Math.random() * 5) - 2;
                    let dy = Math.floor(Math.random() * 5) - 2;
                    
                    // Get pixel at smudge origin
                    let originIdx = ((y + dy) * width + (x + dx)) * 4;
                    
                    // Skip if out of bounds
                    if (originIdx < 0 || originIdx >= data.length) continue;
                    
                    // Blend with neighbor pixel
                    tempData[centerIdx] = (data[centerIdx] * 0.7 + data[originIdx] * 0.3);
                    tempData[centerIdx + 1] = (data[centerIdx + 1] * 0.7 + data[originIdx + 1] * 0.3);
                    tempData[centerIdx + 2] = (data[centerIdx + 2] * 0.7 + data[originIdx + 2] * 0.3);
                }
            }
            
            // Create new ImageData and draw it
            let smudgedImage = new ImageData(tempData, width, height);
            ctx.putImageData(smudgedImage, 0, 0);
        }
        
        // Save current state to history
        function saveToHistory() {
            // Get current canvas state
            const imageData = canvas.toDataURL();
            
            // If we have made changes after undoing, remove future history
            if (state.historyIndex < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyIndex + 1);
            }
            
            // Add current state to history
            state.history.push({
                imageData,
                settings: { ...state.settings },
                effect: state.currentEffect
            });
            
            // Update history index
            state.historyIndex = state.history.length - 1;
            
            // Update history UI
            updateHistoryUI();
        }
        
        // Update history UI
        function updateHistoryUI() {
            // Clear history container
            historyContainer.innerHTML = '';
            
            // Add history items
            state.history.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `<img src="${item.imageData}" alt="History ${index + 1}">`;
                
                // Add active class to current history item
                if (index === state.historyIndex) {
                    historyItem.classList.add('active');
                }
                
                // Add click event to restore state
                historyItem.addEventListener('click', () => {
                    restoreFromHistory(index);
                });
                
                historyContainer.appendChild(historyItem);
            });
        }
        
        // Restore from history
        function restoreFromHistory(index) {
            if (index < 0 || index >= state.history.length) return;
            
            // Set history index
            state.historyIndex = index;
            
            // Get history item
            const historyItem = state.history[index];
            
            // Create image from data URL
            const img = new Image();
            img.src = historyItem.imageData;
            
            img.onload = () => {
                // Restore canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Restore settings
                state.settings = { ...historyItem.settings };
                state.currentEffect = historyItem.effect;
                
                // Update sliders
                updateSlidersFromSettings();
                
                // Update style selection
                updateStyleSelection();
                
                // Update result canvas
                resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
                resultCtx.drawImage(canvas, 0, 0, resultCanvas.width, resultCanvas.height);
                
                // Update history UI
                updateHistoryUI();
            };
        }
        
        // Update sliders from settings
        function updateSlidersFromSettings() {
            intensitySlider.value = state.settings.intensity;
            intensityValue.textContent = state.settings.intensity;
            
            contrastSlider.value = state.settings.contrast;
            contrastValue.textContent = state.settings.contrast;
            
            detailSlider.value = state.settings.detail;
            detailValue.textContent = state.settings.detail;
            
            thicknessSlider.value = state.settings.thickness;
            thicknessValue.textContent = state.settings.thickness;
            
            brightnessSlider.value = state.settings.brightness;
            brightnessValue.textContent = state.settings.brightness;
            
            textureSlider.value = state.settings.texture;
            textureValue.textContent = state.settings.texture;
        }
        
        // Update style selection
        function updateStyleSelection() {
            styleOptions.forEach(option => {
                if (option.dataset.style === state.currentEffect) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }
        
        // Show/hide loading overlay
        function showLoading(show) {
            if (show) {
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }
        
        // Download current canvas
        function downloadImage() {
            // Create a temporary link
            const link = document.createElement('a');
            link.download = `BONHEUR-ART-${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeCanvas();
            
            // File upload
            upload.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                showLoading(true);
                
                try {
                    await loadImage(file);
                    applyEffect();
                } catch (error) {
                    console.error('Error loading image:', error);
                    alert('Erreur lors du chargement de l\'image.');
                } finally {
                    showLoading(false);
                }
            });
            
            // Take photo
            takePhotoBtn.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    videoContainer.style.display = 'flex';
                    video.play();
                    
                    // Start countdown
                    let count = 3;
                    countdown.textContent = count;
                    
                    const countdownInterval = setInterval(() => {
                        count--;
                        if (count > 0) {
                            countdown.textContent = count;
                        } else {
                            countdown.textContent = '';
                            clearInterval(countdownInterval);
                            
                            // Flash effect
                            cameraFlash.classList.add('flash-animation');
                            setTimeout(() => {
                                cameraFlash.classList.remove('flash-animation');
                            }, 500);
                            
                            // Capture photo
                            setTimeout(async () => {
                                // Get video dimensions
                                const videoWidth = video.videoWidth;
                                const videoHeight = video.videoHeight;
                                
                                // Create a temporary canvas
                                const tempCanvas = document.createElement('canvas');
                                tempCanvas.width = videoWidth;
                                tempCanvas.height = videoHeight;
                                const tempCtx = tempCanvas.getContext('2d');
                                
                                // Draw video frame to canvas
                                tempCtx.drawImage(video, 0, 0, videoWidth, videoHeight);
                                
                                // Convert to data URL
                                const imageData = tempCanvas.toDataURL('image/png');
                                
                                // Stop camera
                                stream.getTracks().forEach(track => track.stop());
                                videoContainer.style.display = 'none';
                                
                                // Load the captured image
                                showLoading(true);
                                
                                const img = new Image();
                                img.src = imageData;
                                img.onload = async () => {
                                    try {
                                        await loadImage(img, false);
                                        applyEffect();
                                    } catch (error) {
                                        console.error('Error processing image:', error);
                                    } finally {
                                        showLoading(false);
                                    }
                                };
                            }, 500);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    alert('Impossible d\'accéder à la caméra. Vérifiez les permissions.');
                }
            });
            
            // Close video
            closeVideo.addEventListener('click', () => {
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                videoContainer.style.display = 'none';
            });
            
            // Apply effect
            applyBtn.addEventListener('click', () => {
                applyEffect();
            });
            
            // Reset to original
            resetBtn.addEventListener('click', () => {
                if (state.originalImage) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(state.originalImage, 0, 0, canvas.width, canvas.height);
                    saveToHistory();
                }
            });
            
            // Download
            downloadBtn.addEventListener('click', () => {
                downloadImage();
            });
            
            // Share
            shareBtn.addEventListener('click', () => {
                shareModal.style.display = 'flex';
            });
            
            // Close share modal
            closeShareModal.addEventListener('click', () => {
                shareModal.style.display = 'none';
            });
            
            // Slider events
            intensitySlider.addEventListener('input', (e) => {
                intensityValue.textContent = e.target.value;
            });
            
            contrastSlider.addEventListener('input', (e) => {
                contrastValue.textContent = e.target.value;
            });
            
            detailSlider.addEventListener('input', (e) => {
                detailValue.textContent = e.target.value;
            });
            
            thicknessSlider.addEventListener('input', (e) => {
                thicknessValue.textContent = e.target.value;
            });
            
            brightnessSlider.addEventListener('input', (e) => {
                brightnessValue.textContent = e.target.value;
            });
            
            textureSlider.addEventListener('input', (e) => {
                textureValue.textContent = e.target.value;
            });
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // Add active class to selected tab and content
                    tab.classList.add('active');
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
            
            // Style selection
            styleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove active class from all options
                    styleOptions.forEach(opt => opt.classList.remove('active'));
                    
                    // Add active class to selected option
                    option.classList.add('active');
                    
                    // Update current effect
                    state.currentEffect = option.dataset.style;
                    
                    // Apply effect if there's an image
                    if (state.originalImage) {
                        applyEffect();
                    }
                });
            });
            
            // Initialize tooltips
            document.querySelectorAll('[data-tooltip]').forEach(element => {
                element.addEventListener('mouseenter', (e) => {
                    const tooltipText = e.target.dataset.tooltip;
                    tooltip.textContent = tooltipText;
                    tooltip.classList.add('show');
                    
                    // Position tooltip
                    const rect = e.target.getBoundingClientRect();
                    tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;
                    tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                });
                
                element.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });
            });
        });
    </script>
</body>
</html>
